<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP Mobi - Centro de Controle Operacional</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://maps.googleapis.com/maps/api/js?key=SUA_CHAVE_AQUI&libraries=geometry"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --dark: #0f172a;
            --text-main: #334155;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { height: 100vh; width: 100vw; overflow: hidden; background-color: var(--dark); }
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }

        .dashboard-panel {
            position: absolute; top: 20px; left: 20px; z-index: 10; width: 380px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; max-height: calc(100vh - 40px); overflow-y: auto;
        }

        .header {
            background: var(--dark); color: white; padding: 20px; border-radius: 16px 16px 0 0;
            display: flex; align-items: center; gap: 15px;
        }

        .header img { height: 40px; background: white; border-radius: 8px; padding: 2px; }
        .header-titles h1 { font-size: 16px; font-weight: 700; margin: 0; }
        .header-titles p { font-size: 12px; color: #94a3b8; margin: 0; }

        .panel-content { padding: 20px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; }
        .stat-card.critical { grid-column: span 2; border-color: var(--danger); background: var(--danger-bg); }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--dark); margin-top: 5px; }

        .legenda-mapa {
            background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 20px;
            border: 1px solid #e2e8f0; font-size: 12px; color: var(--text-main);
        }
        .legenda-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .circulo-legenda { width: 12px; height: 12px; border-radius: 50%; background: rgba(239, 68, 68, 0.4); border: 2px solid #ef4444; }
        .pin-legenda { width: 12px; height: 12px; border-radius: 50%; background: #000; }

        .controls-section h3 { font-size: 14px; margin-bottom: 10px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; }
        .instrucao { font-size: 13px; color: var(--text-muted); background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
        .btn-limpar { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 15px;}
        
        .alert-box { display: none; margin-top: 20px; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.5; color: white; }
        .status-badge { display: inline-block; padding: 4px 8px; background: white; border-radius: 4px; font-size: 11px; font-weight: bold; margin-bottom: 8px; }

        #loading-geocoding { font-size: 12px; color: var(--primary); text-align: center; margin-top: 10px; font-weight: bold; }

        /* Rodapé Acadêmico Personalizado */
        .footer-creditos {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }
    </style>
</head>
<body>

    <div class="dashboard-panel">
        <div class="header">
            <img src="logo.png" alt="Logo" onerror="this.style.display='none'"> 
            <div class="header-titles">
                <h1>Monitoramento de Sinistros</h1>
                <p>RP Mobi — Ribeirão Preto/SP</p>
            </div>
        </div>

        <div class="panel-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Sinistros 2025</div>
                    <div class="stat-value">1.746</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Óbitos 2025</div>
                    <div class="stat-value">86</div>
                </div>
                <div class="stat-card critical">
                    <div class="stat-label">Sincronização Ativa</div>
                    <div class="stat-value" id="contador">0</div>
                    <div id="loading-geocoding">Processando dados oficiais...</div>
                </div>
            </div>

            <div class="legenda-mapa">
                <strong>Legenda do Mapa:</strong>
                <div class="legenda-item" style="margin-top: 8px;">
                    <div class="circulo-legenda"></div> Zonas Críticas de Sinistros
                </div>
                <div class="legenda-item">
                    <div class="pin-legenda"></div> Registros de Óbitos
                </div>
            </div>

            <div class="controls-section">
                <h3>Planejamento de Rota Segura</h3>
                <div class="instrucao" id="painel-instrucao">Aguarde a carga dos dados...</div>
                
                <button class="btn-limpar" onclick="limparRota()">Nova Consulta de Rota</button>

                <div id="alerta-perigo" class="alert-box" style="background: var(--danger);">
                    <div class="status-badge" style="color: var(--danger);">ALERTA DE SEGURANÇA</div><br>
                    Sua rota passa por áreas com <b>alto risco</b>. Considere buscar rotas alternativas ou redobre a atenção.
                </div>
                
                <div id="alerta-seguro" class="alert-box" style="background: #10b981;">
                    <div class="status-badge" style="color: #10b981;">ROTA SEGURA</div><br>
                    Nenhuma zona crítica detectada no trajeto selecionado.
                </div>
            </div>

            <div class="footer-creditos">
                O projeto utilizou os dados oficiais da RP Mobi e foi desenvolvido como projeto de extensão por <b>Ana Bárbara Marques dos Santos</b>.
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        let map, infoWindow, directionsService, directionsRenderer, geocoder;
        let origem = null, destino = null, marcadorOrigem = null;
        let listaPontosVerificacao = []; 
        let totalPontos = 0;

        const zonasDeRisco = [
            {endereco: "Av. Dr. Francisco Junqueira x Jerônimo Gonçalves", risco: "66 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Independência x Nove de Julho", risco: "43 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Presidente Vargas x Nove de Julho", risco: "42 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Professor João Fiúsa x Av. Caramuru", risco: "36 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Maurílio Biagi x Leão XIII", risco: "35 sinistros", maiorCausa: "Colisão / Choque"},
            {endereco: "Av. Dom Pedro I x Rua Bonfim", risco: "26 sinistros", maiorCausa: "Colisão / Atropelamento"},
            {endereco: "Av. Saudade x Rua Monsenhor Siqueira", risco: "24 sinistros", maiorCausa: "Atropelamento"},
            {endereco: "Av. 13 de Maio x Rua Itapura", risco: "23 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Presidente Kennedy x Novo Shopping", risco: "23 sinistros", maiorCausa: "Colisão / Atropelamento"},
            {endereco: "Av. Marechal Costa e Silva x Praça Amin Calil", risco: "21 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Eduardo Andrea Matarazzo x Capitão Salomão", risco: "21 sinistros", maiorCausa: "Colisão / Atropelamento"},
            {endereco: "Av. Caramuru x Rua Primo Tronco", risco: "18 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Nove de Julho x Independência", risco: "18 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Thomaz Alberto Whately x Av. Brasil", risco: "17 sinistros", maiorCausa: "Colisão"},
            {endereco: "Av. Maria de Jesus Condeixa x Arnaldo Victaliano", risco: "17 sinistros", maiorCausa: "Colisão"}
        ];

        const obitos = [
            {endereco: "Av. Thomaz Alberto Whately, 1901", motivo: "Alta velocidade e fluxo de veículos pesados"},
            {endereco: "Av. Brasil x Av. Thomaz Alberto Whately", motivo: "Conflitos de conversão e travessia"},
            {endereco: "Av. Presidente Kennedy, 400", motivo: "Atropelamentos e colisões traseiras"},
            {endereco: "Av. Marechal Costa e Silva, 4174", motivo: "Excesso de velocidade"},
            {endereco: "Av. Dom Pedro I, 295", motivo: "Conflitos em cruzamentos e travessia"},
            {endereco: "Av. Saudade, 1380", motivo: "Travessias irregulares e fluxo intenso"},
            {endereco: "Av. Independência, Pça Salvador Spadoni", motivo: "Conversões perigosas e velocidade"},
            {endereco: "Av. Jerônimo Gonçalves, 100", motivo: "Alta interação pedestres x veículos"},
            {endereco: "Av. Maurílio Biagi, 1870", motivo: "Choque em obstáculo fixo - alta velocidade"},
            {endereco: "Rua Bernardino de Campos, 644", motivo: "Atropelamento em travessia central"},
            {endereco: "Av. Treze de Maio, 353", motivo: "Colisão lateral envolvendo motocicleta"},
            {endereco: "Rua Capitão Salomão, 250", motivo: "Atropelamento por distração de condutor"},
            {endereco: "Av. Eduardo Andrea Matarazzo, 4015", motivo: "Atropelamento em via de trânsito rápido"},
            {endereco: "Rua Nilo Peçanha, 65", motivo: "Atropelamento por falta de visibilidade"}
        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13, center: { lat: -21.1840, lng: -47.8050 },
                styles: [{elementType: 'geometry', stylers: [{color: '#242f3e'}]}, {featureType: 'road', elementType: 'geometry', stylers: [{color: '#38414e'}]}],
                disableDefaultUI: true, zoomControl: true
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, polylineOptions: { strokeColor: '#3b82f6', strokeWeight: 6, strokeOpacity: 0.8 }});
            infoWindow = new google.maps.InfoWindow();
            geocoder = new google.maps.Geocoder();

            carregarDados();
        }

        const delay = (ms) => new Promise(res => setTimeout(res, ms));

        async function carregarDados() {
            const cidadeStr = ", Ribeirão Preto, SP, Brasil";

            for (let p of zonasDeRisco) {
                await delay(380); 
                geocoder.geocode({ address: p.endereco + cidadeStr }, (res, status) => {
                    if (status === "OK") {
                        const loc = res[0].geometry.location;
                        listaPontosVerificacao.push(loc);
                        criarZona(loc, p);
                        contabilizar();
                    }
                });
            }

            for (let o of obitos) {
                await delay(380); 
                geocoder.geocode({ address: o.endereco + cidadeStr }, (res, status) => {
                    if (status === "OK") {
                        const loc = res[0].geometry.location;
                        listaPontosVerificacao.push(loc);
                        criarMarcadorObito(loc, o);
                        contabilizar();
                    }
                });
            }
        }

        function contabilizar() {
            totalPontos++;
            document.getElementById("contador").innerText = totalPontos;
            if (totalPontos >= (zonasDeRisco.length + obitos.length)) {
                document.getElementById("loading-geocoding").innerText = "Sincronização Finalizada";
                document.getElementById("painel-instrucao").innerHTML = "Clique no mapa para definir a <b>Origem</b>.";
                habilitarMapa();
            }
        }

        function criarZona(pos, p) {
            const circle = new google.maps.Circle({
                strokeColor: "#ef4444", fillColor: "#ef4444", fillOpacity: 0.35,
                map: map, center: pos, radius: 260
            });
            circle.addListener("click", () => {
                infoWindow.setContent(`
                    <div style="color: #0f172a; font-family: 'Inter', sans-serif;">
                      <h3 style="margin: 0 0 5px 0; font-size: 14px; color: #ef4444;">ZONA CRÍTICA</h3>
                      <p style="margin: 0 0 8px 0; font-weight: bold; font-size: 13px;">${p.endereco}</p>
                      <p style="margin: 0; font-size: 12px;"><b>Fator de Risco:</b> ${p.risco}</p>
                      <p style="margin: 0; font-size: 12px;"><b>Maior Causa:</b> ${p.maiorCausa}</p>
                    </div>
                `);
                infoWindow.setPosition(pos); infoWindow.open(map);
            });
        }

        function criarMarcadorObito(pos, o) {
            const marker = new google.maps.Marker({
                position: pos, map: map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#000", fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2 }
            });
            marker.addListener("click", () => {
                infoWindow.setContent(`
                    <div style="color: #0f172a; font-family: 'Inter', sans-serif;">
                      <h3 style="margin: 0 0 5px 0; font-size: 14px; color: #000;">⚠️ REGISTRO FATAL</h3>
                      <p style="margin: 0 0 8px 0; font-weight: bold; font-size: 13px;">${o.endereco}</p>
                      <p style="margin: 0; font-size: 12px;"><b>Motivo:</b> ${o.motivo}</p>
                    </div>
                `);
                infoWindow.open(map, marker);
            });
        }

        function habilitarMapa() {
            map.addListener("click", (e) => {
                if (!origem) {
                    origem = e.latLng;
                    marcadorOrigem = new google.maps.Marker({ position: origem, map: map, label: "A" });
                    document.getElementById("painel-instrucao").innerHTML = "Agora selecione o <b>Destino</b>.";
                } else if (!destino) {
                    destino = e.latLng;
                    processarRota();
                }
            });
        }

        function processarRota() {
            directionsService.route({ origin: origem, destination: destino, travelMode: 'DRIVING' }, (res, status) => {
                if (status === "OK") {
                    if (marcadorOrigem) marcadorOrigem.setMap(null);
                    directionsRenderer.setDirections(res);
                    verificarSeguranca(res.routes[0].overview_path);
                }
            });
        }

        function verificarSeguranca(path) {
            let risco = false;
            listaPontosVerificacao.forEach(pPos => {
                path.forEach(coord => {
                    if (google.maps.geometry.spherical.computeDistanceBetween(coord, pPos) < 280) risco = true;
                });
            });
            document.getElementById("alerta-perigo").style.display = risco ? "block" : "none";
            document.getElementById("alerta-seguro").style.display = risco ? "none" : "block";
            document.getElementById("painel-instrucao").innerText = "Trajeto finalizado.";
        }

        function limparRota() {
            origem = null; destino = null; if (marcadorOrigem) marcadorOrigem.setMap(null);
            directionsRenderer.setDirections({ routes: [] });
            document.getElementById("alerta-perigo").style.display = "none";
            document.getElementById("alerta-seguro").style.display = "none";
            document.getElementById("painel-instrucao").innerHTML = "Clique no mapa para definir a <b>Origem</b>.";
        }

        window.onload = initMap;
    </script>
</body>
</html>
